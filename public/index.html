<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“Q&Aè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  Premium v4.7</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .version {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
        }

        input[type="url"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-key-section {
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .api-key-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .api-key-section p {
            color: #856404;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .options-section {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .option-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .option-group h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .option-group p {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status-message {
            color: #555;
            text-align: center;
            font-size: 1.1em;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-title {
            font-size: 1.8em;
            color: #333;
        }

        .download-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .label-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .label-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .label-option label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .download-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-pdf-btn {
            background: #dc3545;
            color: white;
        }

        .download-word-btn {
            background: #2b579a;
            color: white;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .qa-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .qa-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .qa-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .qa-question {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
            flex: 1;
        }

        .qa-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .source-label {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }

        .source-specified {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .source-same-domain {
            background: #fff3cd;
            color: #664d03;
            border: 1px solid #ffecb5;
        }

        .source-external {
            background: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .edit-btn {
            background: #0d6efd;
            color: white;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .edit-btn:hover, .delete-btn:hover {
            opacity: 0.8;
        }

        .qa-answer {
            color: #555;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .edit-mode {
            border-color: #0d6efd !important;
            background: #f8f9ff;
        }

        .edit-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            margin-top: 10px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .save-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .save-btn {
            background: #198754;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            color: #842029;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
        }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¿ã‚¤ãƒ« */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            background: #0d6efd;
            color: white;
            border-bottom: 2px solid #0d6efd;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .source-code-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin-top: 10px;
        }

        .source-code-input:focus {
            outline: none;
            border-color: #0d6efd;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #fd7e14;
            font-weight: 600;
        }

        .char-count.error {
            color: #dc3545;
            font-weight: 600;
        }

        .success-message {
            background: #d1e7dd;
            color: #0f5132;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #198754;
            margin: 20px 0;
        }

        .features-list {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .features-list h3 {
            color: #0d6efd;
            margin-bottom: 15px;
        }

        .features-list ul {
            list-style-position: inside;
            color: #333;
        }

        .features-list li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .options-section {
                grid-template-columns: 1fr;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .download-controls {
                width: 100%;
            }

            .download-btn {
                flex: 1;
            }
        }
    
        .error-details {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            font-family: monospace;
        }

        .error-details h4 {
            color: #856404;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }

        .error-code {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .error-explanation {
            background: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin: 10px 0;
            font-family: sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }

        .error-suggestions {
            background: #d1e7dd;
            border-left: 4px solid #198754;
            padding: 15px;
            margin: 10px 0;
            font-family: sans-serif;
        }

        .error-suggestions ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .error-suggestions li {
            margin-bottom: 8px;
        }

        .copy-error-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .copy-error-btn:hover {
            background: #5a6268;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›ï¸ å•†å“Q&Aè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="version">Premium v4.7 - å®Œå…¨ç‰ˆï¼ˆãƒã‚°ä¿®æ­£ï¼‹è‡ªå‹•Q&Aæ•°ï¼‰</div>

        <div class="input-section">
            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('url')">URLå…¥åŠ›</button>
                <button class="tab" onclick="switchTab('source')">HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›</button>
            </div>

            <!-- URLå…¥åŠ›ã‚¿ãƒ– -->
            <div id="urlTab" class="tab-content active">
                <label for="productUrl">å•†å“ãƒšãƒ¼ã‚¸URL:</label>
                <input type="url" id="productUrl" placeholder="https://example.com/product/..." required>
                <p style="font-size: 0.85em; color: #6c757d; margin-top: 8px;">
                    ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã®ã‚ã‚‹URLã®å ´åˆã€ã€ŒHTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã€ã‚¿ãƒ–ã‹ã‚‰ç›´æ¥ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚
                </p>
            </div>

            <!-- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚¿ãƒ– -->
            <div id="sourceTab" class="tab-content">
                <label for="sourceCode">å•†å“ãƒšãƒ¼ã‚¸ã®HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰:</label>
                <p style="font-size: 0.85em; color: #6c757d; margin-bottom: 10px;">
                    ğŸ“ ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œãƒšãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã€ã§HTMLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                    âš ï¸ æœ€å¤§2MBï¼ˆç´„2,000,000æ–‡å­—ï¼‰ã¾ã§å¯¾å¿œã€‚å¤§ãã™ãã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
                </p>
                <textarea 
                    id="sourceCode" 
                    class="source-code-input" 
                    placeholder="<!DOCTYPE html>\n<html>\n<head>...</head>\n<body>...\nã“ã“ã«HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"
                    oninput="updateCharCount()"></textarea>
                <div id="charCount" class="char-count">0 / 2,000,000 æ–‡å­—</div>
            </div>

            <div class="api-key-section">
                <h3>ğŸ”‘ OpenAI APIã‚­ãƒ¼è¨­å®š</h3>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã¯é«˜å“è³ªãªAIç”Ÿæˆã®ãŸã‚OpenAI APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
                <label for="apiKey">OpenAI APIã‚­ãƒ¼:</label>
                <input type="password" id="apiKey" placeholder="sk-...">
                <p style="margin-top: 10px; font-size: 0.85em;">
                    âš ï¸ APIã‚­ãƒ¼ã¯ <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #0d6efd;">OpenAI Platform</a> ã§å–å¾—ã§ãã¾ã™ã€‚<br>
                    ğŸ’¡ ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
                </p>
            </div>

            <div class="options-section">
                <div class="option-group">
                    <h4>ğŸ“Š å‡ºåŠ›ã™ã‚‹Q&Aæ•°</h4>
                    <p>ç”Ÿæˆã™ã‚‹Q&Aã®æ•°ã‚’10å€‹åˆ»ã¿ã§é¸æŠã§ãã¾ã™ï¼ˆ10ã€œ100å€‹ï¼‰</p>
                    <label for="qaCount">Q&Aæ•°:</label>
                    <select id="qaCount">
                        <option value="auto" selected>æŒ‡å®šã—ãªã„ï¼ˆè‡ªå‹•ã§æœ€é©ãªæ•°ã‚’ç”Ÿæˆï¼‰</option>
                        <option value="10">10å•</option>
                        <option value="20">20å•</option>
                        <option value="30">30å•</option>
                        <option value="40">40å•</option>
                        <option value="50">50å•</option>
                        <option value="60">60å•</option>
                        <option value="70">70å•</option>
                        <option value="80">80å•</option>
                        <option value="90">90å•</option>
                        <option value="100">100å•</option>
                    </select>
                </div>

                <div class="option-group">
                    <h4>ğŸ” æƒ…å ±ã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—</h4>
                    <p>Q&Aã®æƒ…å ±æºã‚’é¸æŠã§ãã¾ã™ã€‚é¸æŠã—ãŸã‚½ãƒ¼ã‚¹ã®ã¿ã‚’å…ƒã«Q&Aã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                    <label for="sourceType">ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—:</label>
                    <select id="sourceType">
                        <option value="both">æŒ‡å®šURL + å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ä¸¡æ–¹</option>
                        <option value="specified_url">æŒ‡å®šURLã®ã¿</option>
                        <option value="external">å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®ã¿</option>
                    </select>
                </div>
            </div>

            <button class="generate-btn" onclick="generateQA()">
                ğŸš€ Q&Aã‚’ç”Ÿæˆã™ã‚‹
            </button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status-message" id="statusMessage">å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 class="results-title">ğŸ“‹ ç”Ÿæˆçµæœ</h2>
                <div class="download-controls">
                    <div class="label-option">
                        <input type="checkbox" id="includeLabels" checked>
                        <label for="includeLabels">æƒ…å ±ã‚½ãƒ¼ã‚¹ãƒ©ãƒ™ãƒ«ã‚’å«ã‚ã‚‹</label>
                    </div>
                    <button class="download-btn download-pdf-btn" onclick="downloadPDF()">
                        <span>ğŸ“„</span>
                        <span>PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </button>
                    <button class="download-btn download-word-btn" onclick="downloadRTF()">
                        <span>ğŸ“</span>
                        <span>RTFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </button>
                </div>
            </div>
            <div id="qaList"></div>
        </div>

        <div class="features-list">
            <h3>âœ¨ v4.7 ä¸»è¦æ©Ÿèƒ½</h3>
            <ul>
                <li><strong>Q&Aæ•°é¸æŠæ©Ÿèƒ½:</strong> ç”Ÿæˆã™ã‚‹Q&Aã®æ•°ã‚’10ã€œ100å€‹ã¾ã§10å€‹åˆ»ã¿ã§é¸æŠå¯èƒ½</li>
                <li><strong>ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—é¸æŠæ©Ÿèƒ½:</strong> ã€ŒæŒ‡å®šURLã®ã¿ã€ã€Œå¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ã€ã€Œä¸¡æ–¹ã€ã‹ã‚‰æƒ…å ±æºã‚’é¸æŠå¯èƒ½</li>
                <li><strong>RTFå½¢å¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:</strong> PDFå½¢å¼ã«åŠ ãˆã¦ã€RTF (ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ) å½¢å¼ã§ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ (Word/WordPad/LibreOfficeã§é–‹ã‘ã¾ã™)</li>
                <li><strong>æƒ…å ±ã‚½ãƒ¼ã‚¹åˆ¥ãƒ©ãƒ™ãƒªãƒ³ã‚°:</strong> å„Q&Aã®æƒ…å ±æºã‚’3æ®µéšã§è‡ªå‹•åˆ†é¡ï¼ˆæŒ‡å®šãƒšãƒ¼ã‚¸/åŒãƒ‰ãƒ¡ã‚¤ãƒ³/å¤–éƒ¨ææ¡ˆï¼‰</li>
                <li><strong>ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ¤å®š:</strong> é´ã€ã‚¢ãƒ‘ãƒ¬ãƒ«ã€åŒ–ç²§å“ã€ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã€é£Ÿå“ãªã©12ã‚«ãƒ†ã‚´ãƒªã«å¯¾å¿œ</li>
                <li><strong>ç”»åƒOCRåˆ†æ:</strong> å•†å“ãƒšãƒ¼ã‚¸ã®ç”»åƒã‹ã‚‰æƒ…å ±ã‚’è‡ªå‹•æŠ½å‡º</li>
                <li><strong>å¤–éƒ¨æƒ…å ±ãƒªã‚µãƒ¼ãƒ:</strong> ä¸è¶³æƒ…å ±ã‚’è‡ªå‹•çš„ã«å¤–éƒ¨ã‹ã‚‰è£œå®Œï¼ˆAIã«ã‚ˆã‚‹ææ¡ˆã¨ã—ã¦æ˜ç¤ºï¼‰</li>
                <li><strong>æ³•ä»¤éµå®ˆæ©Ÿèƒ½:</strong> è–¬æ©Ÿæ³•ã€æ™¯å“è¡¨ç¤ºæ³•ã€é£Ÿå“è¡¨ç¤ºæ³•ã«æº–æ‹ ã—ãŸè¡¨ç¾ã‚’è‡ªå‹•ç”Ÿæˆ</li>
                <li><strong>ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½:</strong> ç”Ÿæˆå¾Œã®Q&Aã‚’è‡ªç”±ã«ç·¨é›†ãƒ»å‰Šé™¤å¯èƒ½</li>
            </ul>
        </div>
    </div>

    <script>
        let qaData = [];
        let currentEditingIndex = null;
        let currentInputMode = 'url'; // 'url' or 'source'

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«APIã‚­ãƒ¼ã‚’å¾©å…ƒ
        window.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchTab(mode) {
            currentInputMode = mode;
            
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (mode === 'url') {
                tabs[0].classList.add('active');
                document.getElementById('urlTab').classList.add('active');
                document.getElementById('sourceTab').classList.remove('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('sourceTab').classList.add('active');
                document.getElementById('urlTab').classList.remove('active');
            }
        }

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆé–¢æ•°
        function updateCharCount() {
            const sourceCode = document.getElementById('sourceCode').value;
            const charCount = sourceCode.length;
            const maxChars = 2000000; // 2MB
            const charCountElement = document.getElementById('charCount');
            
            charCountElement.textContent = `${charCount.toLocaleString()} / ${maxChars.toLocaleString()} æ–‡å­—`;
            
            // è­¦å‘Šè‰²ã‚’å¤‰æ›´
            charCountElement.classList.remove('warning', 'error');
            if (charCount > maxChars) {
                charCountElement.classList.add('error');
            } else if (charCount > maxChars * 0.8) {
                charCountElement.classList.add('warning');
            }
        }


        // ã‚¨ãƒ©ãƒ¼è©³ç´°è§£æé–¢æ•°
        function analyzeError(error, context = {}) {
            const errorMessage = error.message || error.toString();
            const analysis = {
                code: errorMessage,
                type: 'UNKNOWN_ERROR',
                explanation: '',
                suggestions: []
            };

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼
            if (errorMessage.includes('timeout') || errorMessage.includes('ETIMEDOUT') || 
                errorMessage.includes('timed out') || errorMessage.includes('Task timed out')) {
                analysis.type = 'TIMEOUT_ERROR';
                analysis.explanation = `
                    <strong>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼</strong><br>
                    å‡¦ç†ãŒæ™‚é–“åˆ¶é™ï¼ˆ60ç§’ï¼‰ã‚’è¶…ãˆã¾ã—ãŸã€‚<br>
                    Vercel Hobby Planã§ã¯æœ€å¤§60ç§’ã¾ã§ã—ã‹å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚<br>
                    ç¾åœ¨ã®Q&Aæ•°ï¼ˆ${context.qaCount || 'ä¸æ˜'}å•ï¼‰ã§ã¯æ™‚é–“ãŒè¶³ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                `;
                analysis.suggestions = [
                    'Q&Aæ•°ã‚’30å•ã«æ¸›ã‚‰ã™',
                    'ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã€ŒæŒ‡å®šURLã®ã¿ã€ã«å¤‰æ›´',
                    'ã€ŒæŒ‡å®šã—ãªã„ï¼ˆè‡ªå‹•ï¼‰ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨',
                    'Vercel Pro Planï¼ˆ$20/æœˆï¼‰ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰'
                ];
            }
            // APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼
            else if (errorMessage.includes('API key') || errorMessage.includes('Unauthorized') || 
                     errorMessage.includes('401')) {
                analysis.type = 'API_KEY_ERROR';
                analysis.explanation = `
                    <strong>APIã‚­ãƒ¼èªè¨¼ã‚¨ãƒ©ãƒ¼</strong><br>
                    OpenAI APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚<br>
                    APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒæ®‹ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                `;
                analysis.suggestions = [
                    'OpenAI Platform (https://platform.openai.com/api-keys) ã§APIã‚­ãƒ¼ã‚’ç¢ºèª',
                    'æ–°ã—ã„APIã‚­ãƒ¼ã‚’ç”Ÿæˆ',
                    'OpenAIã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜ã‚’ç¢ºèª'
                ];
            }
            // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼
            else if (errorMessage.includes('429') || errorMessage.includes('rate limit') ||
                     errorMessage.includes('Too Many Requests')) {
                analysis.type = 'RATE_LIMIT_ERROR';
                analysis.explanation = `
                    <strong>ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼</strong><br>
                    OpenAI APIã®ä½¿ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚<br>
                    çŸ­æ™‚é–“ã«å¤šãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãŸãŸã‚ã€ä¸€æ™‚çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚
                `;
                analysis.suggestions = [
                    '1ã€œ2åˆ†å¾…ã£ã¦ã‹ã‚‰å†åº¦è©¦ã™',
                    'OpenAI APIã®ä½¿ç”¨åˆ¶é™ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰'
                ];
            }
            // ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã‚¨ãƒ©ãƒ¼
            else if (errorMessage.includes('403') || errorMessage.includes('Forbidden') ||
                     errorMessage.includes('Access denied')) {
                analysis.type = 'ACCESS_DENIED_ERROR';
                analysis.explanation = `
                    <strong>ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã‚¨ãƒ©ãƒ¼</strong><br>
                    æŒ‡å®šã•ã‚ŒãŸURLã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚<br>
                    ã‚µã‚¤ãƒˆã®Botå¯¾ç­–ã‚„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã«ã‚ˆã‚Šã€æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
                `;
                analysis.suggestions = [
                    'ã€ŒHTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã€ã‚¿ãƒ–ã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘ã‚‹',
                    'åˆ¥ã®URLã‚’è©¦ã™',
                    'ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´ã™ã‚‹'
                ];
            }
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
            else if (errorMessage.includes('network') || errorMessage.includes('ECONNREFUSED') ||
                     errorMessage.includes('fetch failed')) {
                analysis.type = 'NETWORK_ERROR';
                analysis.explanation = `
                    <strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</strong><br>
                    ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<br>
                    ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒç¢ºç«‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
                `;
                analysis.suggestions = [
                    'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª',
                    'æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ',
                    'Vercelã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª'
                ];
            }
            // ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼
            else if (errorMessage.includes('memory') || errorMessage.includes('heap') ||
                     errorMessage.includes('out of memory')) {
                analysis.type = 'MEMORY_ERROR';
                analysis.explanation = `
                    <strong>ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼</strong><br>
                    ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒ¢ãƒªãŒä¸è¶³ã—ã¾ã—ãŸã€‚<br>
                    å‡¦ç†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã‚‹ã‹ã€Q&Aæ•°ãŒå¤šã™ãã¾ã™ã€‚
                `;
                analysis.suggestions = [
                    'Q&Aæ•°ã‚’æ¸›ã‚‰ã™ï¼ˆ30å•æ¨å¥¨ï¼‰',
                    'ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã™ï¼ˆ500KBä»¥ä¸‹æ¨å¥¨ï¼‰',
                    'ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã€ŒæŒ‡å®šURLã®ã¿ã€ã«å¤‰æ›´'
                ];
            }
            // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
            else if (errorMessage.includes('parse') || errorMessage.includes('JSON') ||
                     errorMessage.includes('Unexpected token')) {
                analysis.type = 'PARSE_ERROR';
                analysis.explanation = `
                    <strong>ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼</strong><br>
                    ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ãè§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                    ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å•é¡ŒãŒã‚ã‚‹ã‹ã€é€”ä¸­ã§åˆ‡æ–­ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                `;
                analysis.suggestions = [
                    'ã‚‚ã†ä¸€åº¦è©¦ã™',
                    'Q&Aæ•°ã‚’æ¸›ã‚‰ã™',
                    'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰'
                ];
            }
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
            else {
                analysis.explanation = `
                    <strong>äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼</strong><br>
                    è©³ç´°: ${errorMessage}<br>
                    åŸå› ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
                `;
                analysis.suggestions = [
                    'ã‚‚ã†ä¸€åº¦è©¦ã™',
                    'Q&Aæ•°ã‚’30å•ã«æ¸›ã‚‰ã™',
                    'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèª',
                    'å•é¡ŒãŒç¶šãå ´åˆã¯ã‚µãƒãƒ¼ãƒˆã«é€£çµ¡'
                ];
            }

            return analysis;
        }

        // ã‚¨ãƒ©ãƒ¼è©³ç´°è¡¨ç¤ºé–¢æ•°
        function displayDetailedError(error, context = {}) {
            const analysis = analyzeError(error, context);
            const progressSection = document.getElementById('progressSection');
            
            if (!progressSection) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                return;
            }

            const errorDetailsHTML = `
                <div class="error-message">
                    <strong>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong>
                    <div class="error-details">
                        <h4>ğŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°</h4>
                        
                        <div class="error-code">
                            <strong>ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:</strong> ${analysis.type}<br>
                            <strong>ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:</strong><br>
                            <code>${analysis.code}</code>
                        </div>

                        <div class="error-explanation">
                            ${analysis.explanation}
                        </div>

                        <div class="error-suggestions">
                            <strong>ğŸ’¡ è§£æ±ºæ–¹æ³•:</strong>
                            <ul>
                                ${analysis.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>

                        <button class="copy-error-btn" onclick="copyErrorToClipboard(\`${analysis.code}\`)">
                            ğŸ“‹ ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
            `;

            progressSection.innerHTML = errorDetailsHTML;
        }

        // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyErrorToClipboard(errorText) {
            navigator.clipboard.writeText(errorText).then(() => {
                alert('âœ… ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        async function generateQA() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const sourceType = document.getElementById('sourceType').value;

            // Q&Aæ•°ã®å‡¦ç†
            let qaCount = document.getElementById('qaCount').value;
            
            // ã€ŒæŒ‡å®šã—ãªã„ï¼ˆè‡ªå‹•ï¼‰ã€ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            if (qaCount === 'auto') {
                // Hobby Planã®60ç§’åˆ¶é™ã‚’è€ƒæ…®
                // ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦æœ€é©ãªæ•°ã‚’æ±ºå®š
                if (sourceType === 'specified_url') {
                    qaCount = 50; // æŒ‡å®šURLã®ã¿ï¼š50å•ï¼ˆç´„45ç§’ï¼‰
                } else if (sourceType === 'external') {
                    qaCount = 30; // å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ï¼š30å•ï¼ˆç´„35ç§’ï¼‰
                } else {
                    qaCount = 40; // ä¸¡æ–¹ï¼š40å•ï¼ˆç´„50ç§’ï¼‰
                }
                console.log(`Auto Q&A count selected: ${qaCount} questions (sourceType: ${sourceType})`);
                updateProgress(5, `è‡ªå‹•åˆ¤å®š: ${qaCount}å•ã®Q&Aã‚’ç”Ÿæˆã—ã¾ã™...`);
            } else {
                qaCount = parseInt(qaCount);
            }

            // APIã‚­ãƒ¼æ¤œè¨¼
            if (!apiKey) {
                alert('OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆ†å²
            let url = '';
            let sourceCode = '';
            
            if (currentInputMode === 'url') {
                url = document.getElementById('productUrl').value.trim();
                
                if (!url || !url.startsWith('http')) {
                    alert('âš ï¸ æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: https://kutsu.com/products/...ï¼‰');
                    return;
                }
            } else if (currentInputMode === 'source') {
                sourceCode = document.getElementById('sourceCode').value.trim();
                
                if (!sourceCode) {
                    alert('âš ï¸ HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // æ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
                if (sourceCode.length > 2000000) {
                    alert('âš ï¸ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§2,000,000æ–‡å­—ï¼‰ã€‚ã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // åŸºæœ¬çš„ãªHTMLæ§‹é€ ãƒã‚§ãƒƒã‚¯
                if (!sourceCode.includes('<html') && !sourceCode.includes('<body')) {
                    const confirm = window.confirm(
                        'âš ï¸ HTMLã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n' +
                        'æ­£ã—ã„HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã™ã‹ï¼Ÿ\n\n' +
                        'ã€Œã¯ã„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®ã¾ã¾ç¶šè¡Œã—ã¾ã™ã€‚'
                    );
                    if (!confirm) {
                        return;
                    }
                }
                
                // ãƒ€ãƒŸãƒ¼URLã‚’è¨­å®šï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®åˆ¤åˆ¥ç”¨ï¼‰
                url = 'source_code_input';
            }
            
            if (!apiKey || apiKey.length < 20) {
                alert('âš ï¸ æœ‰åŠ¹ãªOpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // APIã‚­ãƒ¼ã‚’ä¿å­˜
            localStorage.setItem('openai_api_key', apiKey);

            // UIåˆæœŸåŒ–
            const generateBtn = document.querySelector('.generate-btn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            
            if (!generateBtn || !progressSection || !resultsSection) {
                console.error('Required DOM elements not found');
                alert('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            generateBtn.disabled = true;
            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            qaData = [];

            try {
                updateProgress(10, 'ã‚¹ãƒ†ãƒƒãƒ—1: å•†å“ãƒšãƒ¼ã‚¸ã‚’å–å¾—ä¸­...');
                
                const requestBody = { 
                    url, 
                    apiKey, 
                    qaCount, 
                    sourceType 
                };
                
                // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€sourceCodeã‚’è¿½åŠ 
                if (currentInputMode === 'source') {
                    requestBody.sourceCode = sourceCode;
                }
                
                const response = await fetch('/api/generate-qa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } else {
                            const errorText = await response.text();
                            errorMessage = errorText.substring(0, 200) || errorMessage;
                        }
                    } catch (parseError) {
                        console.error('Error parsing error response:', parseError);
                    }
                    throw new Error(errorMessage);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6).trim();
                                if (!jsonStr) continue;
                                
                                const data = JSON.parse(jsonStr);
                                
                                if (data.type === 'progress') {
                                    updateProgress(data.progress, data.message);
                                } else if (data.type === 'qa') {
                                    qaData.push(data.data);
                                } else if (data.type === 'complete') {
                                    updateProgress(100, 'âœ… ç”Ÿæˆå®Œäº†ï¼');
                                    displayResults();
                                } else if (data.type === 'error') {
                                    throw new Error(data.message);
                                }
                            } catch (parseError) {
                                console.error('JSON parse error for line:', line, parseError);
                                // éJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
                                if (line.includes('error') || line.includes('Error')) {
                                    throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + line.slice(6, 200));
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error details:', error);
                
                // è©³ç´°ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                displayDetailedError(error, {
                    qaCount: qaCount,
                    sourceType: sourceType,
                    inputMode: currentInputMode
                });
            } finally {
                const generateBtn = document.querySelector('.generate-btn');
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
            }
        }

        function updateProgress(progress, message) {
            const progressFill = document.getElementById('progressFill');
            const statusMessage = document.getElementById('statusMessage');
            
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
            statusMessage.textContent = message;
        }

        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const qaList = document.getElementById('qaList');
            
            qaList.innerHTML = qaData.map((qa, index) => `
                <div class="qa-item" id="qa-${index}">
                    <div class="qa-header">
                        <div class="qa-question">${qa.question}</div>
                        <div class="qa-controls">
                            ${getSourceLabelHTML(qa.sourceType)}
                            <button class="edit-btn" onclick="editQA(${index})">âœï¸ ç·¨é›†</button>
                            <button class="delete-btn" onclick="deleteQA(${index})">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="qa-answer">${qa.answer}</div>
                </div>
            `).join('');
            
            resultsSection.style.display = 'block';
            document.getElementById('progressSection').style.display = 'none';
        }

        function getSourceLabelHTML(sourceType) {
            const labels = {
                'specified_page': '<span class="source-label source-specified">ğŸ“ æŒ‡å®šã•ã‚ŒãŸãƒšãƒ¼ã‚¸</span>',
                'same_domain': '<span class="source-label source-same-domain">ğŸ”— æŒ‡å®šã‚µã‚¤ãƒˆå†…ã®åˆ¥ãƒšãƒ¼ã‚¸</span>',
                'external': '<span class="source-label source-external">ğŸ¤– ãƒ•ã‚¡ã‚¤ã‚¢ãƒ¼ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ææ¡ˆï¼ˆå›ç­”å†…å®¹ã¯ä»®ï¼‰</span>'
            };
            return labels[sourceType] || '';
        }

        function editQA(index) {
            if (currentEditingIndex !== null && currentEditingIndex !== index) {
                cancelEdit(currentEditingIndex);
            }

            const qaItem = document.getElementById(`qa-${index}`);
            const qa = qaData[index];
            
            qaItem.classList.add('edit-mode');
            qaItem.innerHTML = `
                <div class="qa-header">
                    <div class="qa-question">${qa.question}</div>
                </div>
                <textarea class="edit-textarea" id="edit-textarea-${index}">${qa.answer}</textarea>
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveEdit(${index})">ğŸ’¾ ä¿å­˜</button>
                    <button class="cancel-btn" onclick="cancelEdit(${index})">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            
            currentEditingIndex = index;
        }

        function saveEdit(index) {
            const textarea = document.getElementById(`edit-textarea-${index}`);
            qaData[index].answer = textarea.value;
            currentEditingIndex = null;
            displayResults();
        }

        function cancelEdit(index) {
            currentEditingIndex = null;
            displayResults();
        }

        function deleteQA(index) {
            if (confirm('ã“ã®Q&Aã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                qaData.splice(index, 1);
                displayResults();
            }
        }

        async function downloadPDF() {
            if (qaData.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹Q&AãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const includeLabels = document.getElementById('includeLabels').checked;
            const url = document.getElementById('productUrl').value.trim();

            try {
                const response = await fetch('/api/download-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        qaData, 
                        productUrl: url,
                        includeLabels 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('PDF Error Response:', errorText);
                    throw new Error('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `product-qa-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Download error:', error);
                alert('PDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function downloadRTF() {
            if (qaData.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹Q&AãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const includeLabels = document.getElementById('includeLabels').checked;
            const url = document.getElementById('productUrl').value.trim();

            try {
                const response = await fetch('/api/download-rtf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        qaData, 
                        productUrl: url,
                        includeLabels 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('RTF Error Response:', errorText);
                    throw new Error('RTFæ–‡æ›¸ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `product-qa-${Date.now()}.rtf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Download error:', error);
                alert('RTFæ–‡æ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    </script>
</body>
</html>
